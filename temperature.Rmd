---
title: Analysis of ARPAV Temperature Data
author: Guglielmo Bordin, Alessio Pitteri
date: "`r gsub('^0', '', format(Sys.Date(), '%d %B %Y'))`"
output:
    rmdformats::robobook:
        fig_width: 8
        fig_height: 5
        thumbnails: false
        lightbox: true
        gallery: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, dev = "svg")
```

```{r}
library(tidyverse)
library(R2jags)
library(bayesplot)

global_seed <- 30172
set.seed(global_seed)

global_font <- "Roboto Condensed"
theme_set(theme_minimal(base_size = 15, base_family = global_font))
my_pal <- wesanderson::wes_palette("Zissou1", 5)[c(1, 3, 5)]
```

```{r}
get_daily_data <- function(station) {
    require(readr)

    fname <- paste0("./data/temp/", station, ".csv")

    read_csv(
        fname,
        col_names = c("date", "min", "avg", "max"),
        skip = 1
    ) |> na.omit()
}

get_monthly_data <- function(station) {
    require(dplyr)
    require(lubridate)

    get_daily_data(station) |>
        mutate(
            year = year(.data$date),
            month = month(.data$date, label = TRUE)
        ) |>
        group_by(year, month) |>
        summarize(
            min = mean(.data$min),
            avg = mean(.data$avg),
            max = mean(.data$max)
        )
}

temp_change_heatmaps <- function(station, avg_window) {
    require(forcats)
    require(ggplot2)
    require(scales)
    require(stringr)
    require(wesanderson)

    data <- get_monthly_data(station)

    years <- unique(data$year)

    baseline <- data |>
        filter(.data$year <= years[avg_window]) |>
        group_by(.data$month) |>
        summarize(
            min = mean(.data$min),
            avg = mean(.data$avg),
            max = mean(.data$max)
        )

    station_name <- station |>
        str_split_1("_") |>
        paste(collapse = " ") |>
        str_to_title() |>
        paste("station")

    temperature_plt <- data |>
        inner_join(baseline, by = "month") |>
        mutate(avg = .data$avg.x - .data$avg.y) |>
        ggplot() +
            geom_tile(
                aes(x = .data$year, y = fct_rev(.data$month),
                fill = .data$avg)
            ) +
            annotate(
                geom = "rect",
                xmin = years[1] - 0.5, xmax = years[avg_window] + 0.5,
                ymin = 12.5, ymax = 0.5,
                fill = "grey50", alpha = 0.4
            ) +
            scale_x_continuous(
                breaks = pretty_breaks(),
                expand = c(0, 0)
            ) +
            scale_fill_gradientn(
                colours = wes_palette("Zissou1", 10, "continuous")
            ) +
            labs(
                x = "Year", y = "Month", fill = "Deviation (째C)",
                title = paste0(
                    "Deviation of the average monthly ",
                    "temperature w.r.t. the ",
                    years[1], "-", years[avg_window], " period"
                ),
                subtitle = station_name
            )

    excursion_plt <- data |>
        inner_join(baseline, by = "month") |>
        mutate(
            diff = .data$max.x - .data$min.x - .data$max.y + .data$min.y
        ) |>
        ggplot() +
            geom_tile(
                aes(x = .data$year, y = fct_rev(.data$month),
                fill = diff)
            ) +
            annotate(
                geom = "rect",
                xmin = years[1] - 0.5, xmax = years[avg_window] + 0.5,
                ymin = 12.5, ymax = 0.5,
                fill = "grey50", alpha = 0.4
            ) +
            scale_x_continuous(
                breaks = pretty_breaks(),
                expand = c(0, 0)
            ) +
            scale_fill_gradientn(
                colours = wes_palette("Zissou1", 10, "continuous")
            ) +
            labs(
                x = "Year", y = "Month", fill = "Deviation (째C)",
                title = paste0(
                    "Deviation of the average monthly thermal ",
                    "excursion w.r.t. the ",
                    years[1], "-", years[avg_window], " period"
                ),
                subtitle = station_name
        )

    list(temperature = temperature_plt, excursion = excursion_plt)
}
```

```{r}
temp_change_heatmaps(station = "castelfranco_veneto", avg_window = 10)
```

```{r}
get_yearly_data <- function(station) {
    data <- get_daily_data(station)

    full_years <- data |>
        mutate(year = year(.data$date), month = month(.data$date)) |>
        group_by(year, month) |>
        count() |>
        group_by(year) |>
        filter(n() == 12) |>
        distinct(year) |>
        pull()

    data |>
        mutate(year = year(.data$date)) |>
        filter(year %in% full_years) |>
        group_by(year) |>
        summarize(avg = mean(.data$avg))
}
```

```{r}
lin_model <- "
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            mu[i] <- a + b * year[i]
            avg[i] ~ dnorm(mu[i], tau)
        }
        
        a ~ dnorm(0, 1e-6)
        b ~ dnorm(0, 1e-6)
        sigma ~ dexp(0.0001)
    }"

lin_pars <- c("a", "b", "sigma")

const_model <- "
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            avg[i] ~ dnorm(a, tau);
        }

        a ~ dnorm(0, 1e-6)
        sigma ~ dexp(0.0001);
    }"

const_pars <- c("a", "sigma")

quad_model <- "
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            mu[i] <- a + b * year[i] + c * year[i] * year[i]
            avg[i] ~ dnorm(mu[i], tau)
        }
        
        a ~ dnorm(0, 1e-6)
        b ~ dnorm(0, 1e-6)
        c ~ dnorm(0, 1e-6)
        sigma ~ dexp(0.0001)
    }"

quad_pars <- c("a", "b", "c", "sigma")

init_variables <- function(model) {
    if (model == lin_model) {
        function() {
            list(
                a = runif(1, -200, 0),
                b = runif(1, 0, 1),
                sigma = runif(1, 0, 1)
            )
        }
    } else if (model == const_model) {
        function() {
            list(
                a = runif(1, -200, 0),
                sigma = runif(1, 0, 1)
            )
        }
    } else if (model == quad_model) {
        function() {
            list(
                a = runif(1, -200, 0),
                b = runif(1, 0, 1),
                c = runif(1, 0, 1),
                sigma = runif(1, 0, 1)
            )
        }
    }
}

regression <- function(station, model, params) {
    R2jags::jags(
        data = get_yearly_data(station),
        inits = init_variables(model),
        parameters.to.save = params,
        model.file = textConnection(model),
        n.chains = 3,
        n.iter = 100000,
        n.burnin = 2000,
        n.thin = 10,
        DIC = FALSE
    ) |> coda::as.mcmc()
}

plot_chains <- function(chain, params) {
    trace_plt <- mcmc_trace(
        chain, pars = params,
        facet_args = list(nrow = length(params), labeller = label_parsed)
    ) +
        facet_text(size = 15) +
        labs(title = "Traces") +
        bayesplot::theme_default(base_size = 15, base_family = global_font)

    dens_plt <- mcmc_dens_overlay(
        chain, pars = params,
        facet_args = list(nrow = length(params), labeller = label_parsed)
    ) +
        facet_text(size = 15) +
        labs(title = "Densities") +
        bayesplot::theme_default(base_size = 15, base_family = global_font)

    gridExtra::grid.arrange(trace_plt, dens_plt, ncol = 2)
}
```

```{r}
lin_chain <- regression("porto_tolle", lin_model, lin_pars)

lin_df <- do.call(rbind.data.frame, lin_chain)
sig_level <- quantile(lin_df$b, probs = 0.05)

ggplot(lin_df) +
    geom_density(aes(b), colour = my_pal[1], fill = my_pal[1], alpha = 0.5) +
    geom_area(
        aes(x, y),
        data = tibble(
            x = density(lin_df$b, from = -0.01, to = sig_level)$x,
            y = density(lin_df$b, from = -0.01, to = sig_level)$y),
        colour = my_pal[3], fill = my_pal[3], alpha = 0.5
    ) +
    geom_vline(xintercept = 0, colour = my_pal[2], linewidth = 0.8) +
    coord_cartesian(expand = FALSE)
```

```{r}
quad_chain <- regression("porto_tolle", quad_model, quad_pars) |>
    plot_chains(quad_pars)
```

```{r}
lm_fit <- lm(avg ~ year + I(year^2), get_yearly_data("porto_tolle"))
lm_params <- summary(lm_fit)$coefficients[, 1]
lm_errs <- summary(lm_fit)$coefficients[, 2]

quad_model <- sprintf("
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            mu[i] <- a + b * year[i] + c * year[i] * year[i]
            avg[i] ~ dnorm(mu[i], tau)
        }
        
        a ~ dnorm(%e, %e)
        b ~ dnorm(%e, %e)
        c ~ dnorm(%e, %e)
        sigma ~ dexp(0.0001)
    }",
    lm_params[1], 1 / lm_errs[1]^2,
    lm_params[2], 1 / lm_errs[2]^2,
    lm_params[3], 1 / lm_errs[3]^2
)

quad_pars <- c("a", "b", "c", "sigma")

quad_chain <- regression("porto_tolle", quad_model, quad_pars)

best_pars <- quad_chain |>
    tidybayes::tidy_draws() |>
    select(a, b, c, sigma) |>
    summarize(a = mean(a), b = mean(b), c = mean(c), sigma = mean(sigma))
```

```{r}
correlation_plot <- function(stat1, stat2, name1, name2){

    df <- inner_join(stat1, stat2, by = "year", suffix = c(".s1", ".s2"))
    
    plot <- ggplot(df, aes(x = avg.s1, y = avg.s2)) +
            geom_point(aes(colour = year), size = 3) +
            ggrepel::geom_label_repel(
                aes(label = year, colour = year),
                data = \(x) x |> filter(row_number() %% 3 == 1),
                min.segment.length = 0,
                box.padding = 0.5
            ) +
            labs(
                x = paste(name1, "temperature (째C)"),
                y = paste(name2, "temperature (째C)"),
                colour = "Year",
                title = paste(
                    "Comparison of the average yearly temperatures in",
                    name1, "and", name2
                )
            )
      return(list(cor = cor(df$avg.s1, df$avg.s2, method='pearson'), plot = plot))
}
```

```{r}
name_list <- c("auronzo","castelfranco_veneto","cavallino-treporti",
               "malo","porto_tolle","roverchiara")

C <- correlation_plot(get_yearly_data("malo"), get_yearly_data("roverchiara"),
                        "Malo", "Roverchiara")
C$cor;
C$plot
```


