---
title: Analysis of ARPAV Temperature Data
author: Guglielmo Bordin, Alessio Pitteri
date: "`r gsub('^0', '', format(Sys.Date(), '%d %B %Y'))`"
output:
    rmdformats::robobook:
        fig_width: 8
        fig_height: 5
        thumbnails: false
        lightbox: true
        gallery: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, dev = "svg")
```

```{r}
library(tidyverse)
library(R2jags)
library(bayesplot)

global_seed <- 30172
set.seed(global_seed)

global_font <- "Roboto Condensed"
theme_set(theme_minimal(base_size = 15, base_family = global_font))
my_pal <- c("#EE9C39", "#20A47B", "#5A3920")
```

```{r}
fname <- "./data/temp/malo.csv"
daily_data <- read_csv(
    fname,
    col_names = c("date", "min", "avg", "max"),
    skip = 1,
) |> na.omit()
```

```{r}
monthly_data <- daily_data |>
    mutate(year = year(date), month = month(date, label = TRUE)) |>
    group_by(year, month) |>
    summarize(min = mean(min), avg = mean(avg), max = mean(max))
```

```{r}
years <- unique(monthly_data$year)

base_idx <- 10
baseline <- monthly_data |>
    filter(year <= years[base_idx]) |>
    group_by(month) |>
    summarize(min = mean(min), avg = mean(avg), max = mean(max))

monthly_data |>
    inner_join(baseline, by = "month") |>
    mutate(avg = avg.x - avg.y) |>
    ggplot() +
        geom_tile(aes(x = year, y = fct_rev(month), fill = avg)) +
        annotate(
            geom = "rect",
            xmin = years[1] - 0.5, xmax = years[base_idx] + 0.5,
            ymin = 12.5, ymax = 0.5,
            fill = "grey50", alpha = 0.4
        ) +
        scale_x_continuous(
            breaks = scales::pretty_breaks(),
            expand = c(0, 0)
        ) +
        scale_fill_gradientn(
            colours = wesanderson::wes_palette("Zissou1", 10, "continuous")
        ) +
        labs(
            x = "Year", y = "Month", fill = "Deviation (°C)",
            title = paste0(
                "Deviation of the average monthly ",
                "temperature w.r.t. the ",
                years[1], "-", years[base_idx], " period"
            )
        )
```

```{r}
monthly_data |>
    inner_join(baseline, by = "month") |>
    mutate(diff = (max.x - min.x) - (max.y - min.y)) |>
    ggplot() +
        geom_tile(aes(x = year, y = fct_rev(month), fill = diff)) +
        annotate(
            geom = "rect",
            xmin = years[1] - 0.5, xmax = years[base_idx] + 0.5,
            ymin = 12.5, ymax = 0.5,
            fill = "grey50", alpha = 0.4
        ) +
        scale_x_continuous(
            breaks = scales::pretty_breaks(),
            expand = c(0, 0)
        ) +
        scale_fill_gradientn(
            colours = wesanderson::wes_palette("Zissou1", 10, "continuous")
        ) +
        labs(
            x = "Year", y = "Month", fill = "Deviation (°C)",
            title = paste0(
                "Deviation of the average monthly thermal ",
                "excursion w.r.t. the ",
                years[1], "-", years[base_idx], " period"
            )
        )
```

```{r}
# get only "complete" years
full_years <- monthly_data |>
    group_by(year) |>
    filter(n() == 12) |>
    distinct(year) |>
    pull()

yearly_data <- daily_data |>
    mutate(year = year(date)) |>
    filter(year %in% full_years) |>
    group_by(year) |>
    summarize(avg = mean(avg))
```
```{r}
lin_model <- "
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            mu[i] <- a + b * year[i]
            avg[i] ~ dnorm(mu[i], tau)
        }
        
        a ~ dnorm(0, 1e-6)
        b ~ dnorm(0, 1e-6)
        sigma ~ dexp(0.0001)
    }"

lin_pars <- c("a", "b", "sigma")

lin_chain <- R2jags::jags(
    data = yearly_data,
    inits = function() {
        list(
            a = runif(1, -200, 0),
            b = runif(1, 0, 1),
            sigma = runif(1, 0, 1)
        )
    },
    parameters.to.save = lin_pars,
    model.file = textConnection(lin_model),
    n.chains = 3,
    n.iter = 100000,
    n.burnin = 2000,
    n.thin = 10,
    DIC = FALSE
) |> as.mcmc()
```

```{r, fig.width = 10, fig.height = 8}
trace_plt <- mcmc_trace(
    lin_chain, pars = lin_pars,
    facet_args = list(nrow = 3, labeller = label_parsed)
) +
    facet_text(size = 15) +
    labs(title = "Traces") +
    bayesplot::theme_default(base_size = 15, base_family = global_font)

dens_plt <- mcmc_dens_overlay(
    lin_chain, pars = lin_pars,
    facet_args = list(nrow = 3, labeller = label_parsed)
) +
    facet_text(size = 15) +
    labs(title = "Densities") +
    bayesplot::theme_default(base_size = 15, base_family = global_font)

gridExtra::grid.arrange(trace_plt, dens_plt, ncol = 2)
```

```{r}
const_model <- "
    model {
        tau <- 1 / sigma^2

        for (i in 1:length(year)) {
            avg[i] ~ dnorm(a, tau);
        }

        a ~ dnorm(0, 1e-6)
        sigma ~ dexp(0.0001);
    }"

const_pars <- c("a", "sigma")

const_chain <- R2jags::jags(
    data = yearly_data,
    inits = function() {
        list(a = runif(1, 0, 20), sigma = runif(0, 1))
    },
    parameters.to.save = const_pars,
    model.file = textConnection(const_model),
    n.chains = 3,
    n.iter = 100000,
    n.burnin = 2000,
    n.thin = 10,
    DIC = FALSE
) |> as.mcmc()
```

```{r}
trace_plt <- mcmc_trace(
    const_chain, pars = const_pars,
    facet_args = list(nrow = 3, labeller = label_parsed)
) +
    facet_text(size = 15) +
    labs(title = "Traces") +
    bayesplot::theme_default(base_size = 15, base_family = global_font)

dens_plt <- mcmc_dens_overlay(
    const_chain, pars = const_pars,
    facet_args = list(nrow = 3, labeller = label_parsed)
) +
    facet_text(size = 15) +
    labs(title = "Densities") +
    bayesplot::theme_default(base_size = 15, base_family = global_font)

gridExtra::grid.arrange(trace_plt, dens_plt, ncol = 2)
```