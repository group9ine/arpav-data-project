---
title: Analysis of ARPAV Temperature Data
author: Guglielmo Bordin, Alessio Pitteri
date: "`r gsub('^0', '', format(Sys.Date(), '%d %B %Y'))`"
output:
    rmdformats::robobook:
        fig_width: 8
        fig_height: 5
        thumbnails: false
        lightbox: true
        gallery: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, dev = "svg")
```

```{r}
library(tidyverse)

theme_set(theme_minimal(base_size = 14, base_family = "Roboto Condensed"))
my_pal <- c("#EE9C39", "#20A47B", "#5A3920")
```

```{r}
loc_path <- "./data/temp/malo"

temp_data <- NULL
for (type in c("min", "avg", "max")) {
    file <- list.files(
        path = loc_path,
        full.names = TRUE,
        pattern = paste0("*", type, ".csv")
    )

    tmp_df <- read.csv(file, sep = ";", na.strings = ">>")
    tmp_df <- tmp_df[-ncol(tmp_df)]
    names(tmp_df) <- c("year", 1:12)

    tmp_df <- tmp_df |>
        pivot_longer(-year, names_to = "month", values_to = "value") |>
        add_column(variable = type, .after = "month") |>
        mutate(
            date = make_date(year = year, month = month), .before = 1
        ) |>
        mutate(month = factor(
            month.abb[as.integer(month)], levels = month.abb)
        )

    temp_data <- rbind(temp_data, tmp_df)
}

temp_data <- arrange(temp_data, date) |>
    pivot_wider(names_from = "variable", values_from = "value") |>
    na.omit()
```

```{r}
years <- unique(temp_data$year)

baseline <- temp_data |>
    filter(year <= years[5]) |>
    group_by(month) |>
    summarize(avg = mean(avg))

temp_data |>
    inner_join(baseline, by = "month") |>
    mutate(avg = avg.x - avg.y) |>
    ggplot() +
        geom_tile(aes(x = year, y = fct_rev(month), fill = avg)) +
        scale_x_continuous(
            breaks = scales::pretty_breaks(),
            expand = c(0, 0)
        ) +
        scale_fill_gradientn(
            colours = wesanderson::wes_palette("Zissou1", 10, "continuous")
        ) +
        labs(
            x = "Year", y = "Month", fill = "Deviation (Â°C)",
            title = paste0(
                "Deviation of the average monthly temperature from the ",
                years[1], "-", years[5], " period"
            )
        )
```